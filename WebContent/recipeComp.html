<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Opret recept</title>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="jquery-3.3.1.js"></script>
<script src="Agent.js"></script>
<script>
$(function(){
	loadIngredient();
	$("#add").click(function() {
		element = {};
		element.name = $("select#ingredientDropdown option:selected").text();
		element.id = $("#ingredientDropdown").val();
		$("#rows").append(generateRow(element));
	})
	
	$("#rows").on('click', '.delete', function() {
		var self = $(this).closest("tr");
		self.remove();
	});
	
	$("#submitComp").click(function() {createRecipeComp()});
})

function generateRow(element) {
 	return '<tr><td class="ingId">' + element.id + '</td>' +
	'<td class="recName">' + element.name + '</td>' + 
	'<td> <input class="amount" type="text" placeholder="gram"> </td>' +
	'<td> <input class="tolerance" type="text" placeholder="0.1-20%"> </td>' + 
	'<td class = "deleteCol"> <button class="delete"> Slet </button> </td>)' +
	'</tr>';
}


function createRecipeComp() {
	var urlid = $.urlParam('id');
	$("#rows").find('tr').each(function(i, element) {
		var recipeCompData = {};
		recipeCompData.recipeId = urlid;
		recipeCompData.ingredientId = $(element).find(".ingId").text();
		recipeCompData.amount = $(element).find(".amount").val();
		recipeCompData.tolerance = $(element).find(".tolerance").val();
		
		Agent.postJson('rest/recipeComp', recipeCompData, function() {
                $(element).find(".amount").attr('disabled', true);
                $(element).find(".tolerance").attr('disabled', true);
                $(element).find(".deleteCol").html('<span style = "color:#007a02">✓</span>')
			}
			, function(xhr, statusmsg, errormsg) {
                $(element).find(".deleteCol").html('<span style = "color:#7a0004">✘</span>')
		});	
	})
}

$.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return decodeURI(results[1]) || 0;
    }
}


function loadIngredient() {
     Agent.getJson("rest/ingredient",
        function(data) { 
            $.each(data, function (i, element) { 
                $("#ingredientDropdown").append(generateIngredientHTML(element));
            });
         }
    ); 
}

function generateIngredientHTML(element) {
	return "<option value=" + element.id + ">" + element.name + "</option>";
}

</script>
</head>
<body>
	<div id="menu">
		<b>Menu</b><br>
		<a href="index.html">Log ud</a>
	</div>
	<br><br>
	<div>
	Vælg råvarer   
	  <select id="ingredientDropdown"> <option>Vælg råvare </select>
	<button id="add">Tilføj</button>
	</div>
	<br>
	<table id = recCompTable>
		<thead>
			<tr>
				<td>ID</td>
				<td>Navn</td>
				<td>Mængde</td>
				<td>Tolerance</td>
				<td></td>
			</tr>
		</thead>
		<tbody id=rows>
		
		</tbody>
	</table>
	<a id="submitComp">Færdig</a>
</body>
</html>