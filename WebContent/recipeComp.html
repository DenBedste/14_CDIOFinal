<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Opret recept</title>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="jquery-3.3.1.js"></script>
<script src="Agent.js"></script>
<script>
$(function(){
	loadIngredient();
	loadComps();
	$("#add").click(function() {
        var recipeCompData = {};
        recipeCompData.recipeId = $.urlParam('id');;
        recipeCompData.ingredientId = $("#ingredientDropdown").val();
		recipeCompData.amount = $("#amount").find(".amount").val();
        recipeCompData.tolerance = $("#tolerance").find(".tolerance").val();

        element = {};
        element.name = $("select#ingredientDropdown option:selected").text();
        element.id = $("#ingredientDropdown").val();
        Agent.postJson('rest/recipeComp', recipeCompData, function() {
                $("#rows").append(generateRow(element, true));
            }
            , function(xhr, statusmsg, errormsg) {
                $("#rows").append(generateRow(element, false));
            });



	})
	
	$("#rows").on('click', '.delete', function() {
		var self = $(this).closest("tr");
		self.remove();
	});
	
	$("#finishComps").click(function() {window.location.href = "recipe.html";});
})

function generateRow(element, success) {
 	return '<tr><td class="ingId">' + element.id + '</td>' +
	'<td class="recName">' + element.name + '</td>' +
    '<td>' + (success ? '<span style = "color:#007a02">✓</span></td>' : '<span style = "color:#7a0004">✘</span></td>') +
	'</tr>';
}

$.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return decodeURI(results[1]) || 0;
    }
}


function loadIngredient() {
     Agent.getJson("rest/ingredient",
        function(data) { 
            $.each(data, function (i, element) { 
                $("#ingredientDropdown").append(generateIngredientHTML(element));
            });
         }
    ); 
}

function loadComps() {
    Agent.getJson("rest/recipeComp",
        function(data) {
            $.each(data, function (i, element) {
                element.id = element.ingredientId;
                Agent.getJson('rest/ingredient/' + element.ingredientId, function(data) {
                        element.name = data.name;
                        $("#rows").append(generateRow(element, true));
                    }, function(xhr, statusmsg, errormsg) {
                        element.name = "ERROR";
                        $("#rows").append(generateRow(element, true));
                    });


            });
        }
    );
}

function generateIngredientHTML(element) {
	return "<option value=" + element.id + ">" + element.name + "</option>";
}

</script>
</head>
<body>
	<div id="menu">
		<b>Menu</b><br>
		<a href="index.html">Log ud</a>
	</div>
	<span id="tilbage" onclick="window.history.back()">Tilbage</span>
	
	<br><br>
	<div>
	Vælg råvarer   
	  <select id="ingredientDropdown"> <option>Vælg råvare </select>
        <input id="amount" type="text" placeholder="gram">
        <input id="tolerance" type="text" placeholder="0.1-20%">
        <button id="add">Tilføj</button>
	</div>
	<br>
	<table id = recCompTable border = "1">
		<thead>
			<tr>
				<td>ID</td>
				<td>Navn</td>
				<td></td>
			</tr>
		</thead>
		<tbody id=rows>
		
		</tbody>
	</table>
	<a id="finishComps">Færdig</a>
</body>
</html>